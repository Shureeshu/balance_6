{% extends 'base.html' %}
{% load static %}
{% block content %}
  <p>번호 - {{ post.pk }}</p>
  <p>제목 - {{ post.title }}</p>
  <p>작성자 - {{ post.user }}</p>
  <p>좋아요 수 - <span id="likes-count">{{ post.like_users.all|length }}</span>개</p>
  {% if request.user.is_authenticated %}
    <form id="likes-form" data-post-id="{{ post.pk }}">
      {% csrf_token %}
      {% if request.user in post.like_users.all %}
        <input type="submit" value="좋아요 취소">
      {% else %}
        <input type="submit" value="좋아요">
      {% endif %}
    </form>
  {% else %}
    <input type="submit" value="좋아요" disabled>
  {% endif %}
  <br>
  <hr>
  {% if post.img1 %}
    <img src="{{ post.img1_thumbnail.url }}" alt="">
  {% else %}
    <img src="{% static '1.png' %}" alt="">
  {% endif %}
  <form action="{% url 'posts:answer' post.pk post.select1_content %}" method="POST">
    {% csrf_token %}
      <input type="submit" value="{{ post.select1_content }} - {{ post.select1_users.count }}">
  </form>

  {% if post.img2 %}
    <img src="{{ post.img2_thumbnail.url }}" alt="">
  {% else %}
    <img src="{% static '2.png' %}" alt="">
  {% endif %}
  <form action="{% url 'posts:answer' post.pk post.select2_content %}" method="POST">
    {% csrf_token %}
      <input type="submit" value="{{ post.select2_content }} - {{ post.select2_users.count }}">
  </form>
  <hr>
  <a href="{% url 'posts:index' %}">[뒤로가기]</a>
  <hr>
  <form action="{% url 'posts:comment_create' post.pk %}" method="POST">
    {% csrf_token %}
    {{ comment_form.as_p }}
    <input type="submit">
  </form>
  {% for comment in comments %}
    <p>{{ comment.user }}</p>
    <p>{{ comment.content }}</p>
    <p>{{ comment.created_at }}</p>
    <form action="{% url 'posts:comment_delete' post.pk comment.pk %}" method="POST">
      {% csrf_token %}
      <input type="submit" value="삭제">
    </form>
  {% endfor %}
{% endblock content %}

{% block script %}
  <script>
    const form = document.querySelector('#likes-form')
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value
    form.addEventListener('submit', function (event) {
      event.preventDefault()
      const postId = event.target.dataset.postId
      axios({
        method: 'post',
        url: `/posts/${postId}/likes/`,
        headers: {'X-CSRFToken': csrftoken},
      })
        .then((response) => {
          const isLiked = response.data.is_liked
          const likeBtn = document.querySelector('#likes-form > input[type=submit]')
          if (isLiked === true) {
            likeBtn.value = '좋아요 취소'
          } else {
            likeBtn.value = '좋아요'
          }
          const likesCountTag = document.querySelector('#likes-count')
          const likesCountData = response.data.likes_count
          likesCountTag.textContent = likesCountData
        })

    })
  </script>
{% endblock script %}